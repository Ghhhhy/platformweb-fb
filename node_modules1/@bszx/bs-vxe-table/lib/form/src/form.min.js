"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)}return i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(i),!0).forEach(function(e){_defineProperty(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"content",get:function(){return _tools.UtilTools.getFuncText(this.$options.content||this.$options.message)}},{key:"message",get:function(){return this.content}}]),t}();function getResetValue(e,t){return _ctor.default.isArray(e)&&(t=[]),t}function getItemSlots(e,t){var i,r=e.$scopedSlots,n=t.slots,o={};return n&&(i=n.default)&&r[i]&&(i=r[i]),i&&(o.default=i),o}function renderItems(t,i){var e=i.items;return e?e.map(function(e){return t("vxe-form-item",{props:e,scopedSlots:getItemSlots(i,e)})}):[]}var _default2={name:"VxeForm",props:{loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:[String,Number],align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:[String,Number],titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object},data:function(){return{collapseAll:!0,invalids:[],tooltipTimeout:null,tooltipActive:!1,tooltipStore:{item:null,visible:!1}}},provide:function(){return{$vxeform:this}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)},tooltipOpts:function(){var e=Object.assign({leaveDelay:300},_conf.default.form.tooltipConfig,this.tooltipConfig);return e.enterable&&(e.leaveMethod=this.handleTooltipLeaveMethod),e}},render:function(e){var t,i=this._e,r=this.$slots,n=this.loading,o=this.vSize,l=this.tooltipOpts,a=(this.validOpts,_vXETable.default._tooltip);return e("form",{class:["vxe-form","vxe-row",(t={},_defineProperty(t,"size--".concat(o),o),_defineProperty(t,"is--colon",this.titleColon),_defineProperty(t,"is--asterisk",this.titleAsterisk),_defineProperty(t,"is--loading",n),t)],on:{submit:this.submitEvent,reset:this.resetEvent}},[].concat(r.default||renderItems(e,this)).concat([e("div",{class:["vxe-loading",{"is--visible":n}]},[e("div",{class:"vxe-loading--spinner"})]),a?e("vxe-tooltip",_objectSpread({ref:"tooltip"},l)):i()]))},methods:{getItems:function(){return this.findComponentDownward(this).map(function(e){return{field:e.field,title:e.title,itemRender:e.itemRender}})},toggleCollapse:function(){return this.collapseAll=!this.collapseAll,this.$nextTick()},submitEvent:function(t){var i=this;t.preventDefault(),this.preventSubmit||this.beginValidate().then(function(){i.$emit("submit",{data:i.data,$form:i,$event:t},t)}).catch(function(e){i.$emit("submit-invalid",{data:i.data,errMap:e,$form:i,$event:t},t)})},reset:function(){var o=this,l=this.data;l&&this.findComponentDownward(this).forEach(function(e){var t=e.field,i=e.resetValue,r=e.itemRender;if(t){_ctor.default.set(l,t,null===i?getResetValue(_ctor.default.get(l,t),void 0):i);var n=r?_vXETable.default.renderer.get(r.name):null;n&&n.itemResetMethod&&n.itemResetMethod({data:l,property:t,$form:o})}});return this.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.$emit("reset",{data:this.data,$form:this,$event:e},e)},handleTooltipLeaveMethod:function(){var e=this,t=this.tooltipOpts;return setTimeout(function(){e.tooltipActive||e.closeTooltip()},t.leaveDelay),!1},closeTooltip:function(){var e=this.tooltipStore,t=this.$refs.tooltip;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),this.$nextTick()},triggerHeaderHelpEvent:function(e,t,i){var r=t.item;if(!1!==t.showTooltip){var n=this.tooltipStore,o=this.$refs.tooltip,l=e.currentTarget,a=!1,s="",u=l.querySelector(".vxe-input input"),c=l.querySelector("span.text"),f=l.querySelector(".vxe-textarea textarea");a=i&&u?(s=(l=u).value,l.scrollWidth>l.clientWidth):i&&c?(s=(l=c).textContent,l.scrollWidth>l.clientWidth):i&&f?(s=(l=f).value,l.scrollHeight>l.clientHeight):(s=(l.textContent||"").trim(),l.scrollWidth>l.clientWidth),clearTimeout(this.tooltipTimeout),this.tooltipActive=!0,this.closeTooltip(),s&&a&&(Object.assign(n,{item:r,visible:!0}),o&&o.open(l,s,"formItem"))}},handleTargetLeaveEvent:function(){var t=this,e=this.tooltipOpts;this.tooltipActive=!1,e.enterable?this.tooltipTimeout=setTimeout(function(){var e=t.$refs.tooltip;e&&!e.isHover&&t.closeTooltip()},e.leaveDelay):this.closeTooltip()},clearValidate:function(t){return t?_ctor.default.remove(this.invalids,function(e){return e.property===t}):this.invalids=[],this.$nextTick()},validate:function(e){return this.validFields=[],this.beginValidate("",e)},beginValidate:function(r,e){var n=this,o=this.data,t=this.rules,i=this.validOpts,l=this.findComponentDownward(this),a={},s=[],u=[];return this.clearValidate(),o&&t?(l.forEach(function(e){var i=e.field,t=e.visible;i&&!1!==t&&u.push(n.validItemRules(r||"all",i).catch(function(e){var t={rule:e.rule,rules:e.rules,data:o,property:i,$form:n};return a[i]||(a[i]=[]),a[i].push(t),s.push(i),n.invalids.push(t),Promise.reject(t)}))}),Promise.all(u).then(function(){e&&e()}).catch(function(){return e&&e(a),i.autoPos&&(n.validFields=s),Promise.reject(a)})):(e&&e(),Promise.resolve())},validItemRules:function(n,o,e){var l=this,a=this.data,t=this.rules,s=[],u=[];if(o&&t){var c=_ctor.default.get(t,o);if(c){var f=_ctor.default.isUndefined(e)?_ctor.default.get(a,o):e;c.forEach(function(t){if("all"===n||!t.trigger||n===t.trigger)if(_ctor.default.isFunction(t.validator)){var e=t.validator({itemValue:f,rule:t,rules:c,data:a,property:o,$form:l});e&&(_ctor.default.isError(e)?s.push(new Rule({type:"custom",trigger:t.trigger,message:e.message,rule:new Rule(t)})):e.catch&&u.push(e.catch(function(e){s.push(new Rule({type:"custom",trigger:t.trigger,message:e?e.message:t.content||t.message,rule:new Rule(t)}))})))}else{var i="number"===t.type,r=i?_ctor.default.toNumber(f):_ctor.default.getSize(f);null==f||""===f?t.required&&s.push(new Rule(t)):(i&&isNaN(f)||!isNaN(t.min)&&r<parseFloat(t.min)||!isNaN(t.max)&&r>parseFloat(t.max)||t.pattern&&!(t.pattern.test?t.pattern:new RegExp(t.pattern)).test(f))&&s.push(new Rule(t))}})}}return Promise.all(u).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},findComponentUpward:function(e,t){for(var i=e.$parent,r=i.$options.name;i&&(!r||t!==r);)(i=i.$parent)&&(r=i.$options.name);return i},findComponentDownward:function(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"VxeFormItem",r=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];return e.$children.forEach(function(e){i===e.$options.name?(n.push(e),r&&Array.isArray(e.$children)&&e.$children.length&&t.findComponentDownward(e,i,r,n)):Array.isArray(e.$children)&&e.$children.length&&t.findComponentDownward(e,i,r,n)}),n},handleFocus:function(e){var t=this.validOpts,u=this.findComponentDownward(this);t.autoPos&&e.some(function(t){var e=_ctor.default.find(u,function(e){return e.field===t});if(e&&e.itemRender){var i,r=e.$el,n=e.itemRender,o=_vXETable.default.renderer.get(n.name);if(n.autofocus&&(i=r.querySelector(n.autofocus)),!i&&o&&o.autofocus&&(i=r.querySelector(o.autofocus)),i){if(i.click(),i.focus(),_tools.DomTools.browse.msie){var l=i.createTextRange();l.collapse(!1),l.select()}return!0}var a=r.querySelector(".vxe-input input"),s=r.querySelector(".vxe-textarea textarea");a?(i.click(),a.focus()):s&&s.focus()}})},updateStatus:function(e,t){var n=this,o=e.property;o&&this.validItemRules("change",o,t).then(function(){n.clearValidate(o)}).catch(function(e){var t=e.rule,i=e.rules,r=_ctor.default.find(n.invalids,function(e){return e.property===o});r?(r.rule=t,r.rules=i):n.invalids.push({rule:t,rules:i,property:o})})}}};exports.default=_default2;
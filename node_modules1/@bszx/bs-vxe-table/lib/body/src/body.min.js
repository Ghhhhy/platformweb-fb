"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var l=Object.prototype.toString.call(e).slice(8,-1);return"Object"===l&&e.constructor&&(l=e.constructor.name),"Map"===l||"Set"===l?Array.from(e):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var l=0,o=new Array(t);l<t;l++)o[l]=e[l];return o}function _defineProperty(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}var scrollProcessTimeout,cellType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function countTreeExpand(e,t){var l=t.$table,o=e[l.treeOpts.children],r=1;if(l.isTreeExpandByRow(e))for(var n=0;n<o.length;n++)r+=countTreeExpand(o[n],t);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t){var l=e.$table,o=e.$rowIndex,r=1;return o&&(r=countTreeExpand(t[o-1],e)),l.rowHeight*r-(o?1:12-getOffsetSize(l))}function renderLine(e,t,l,o,r,n){var a=n.column,s=l.treeOpts,i=l.treeConfig;return a.slots&&a.slots.line?a.slots.line.call(l,n,e):a.treeNode&&i&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(o*s.indent+(o?2-getOffsetSize(l):0)+16,"px")}})])]:[]}function renderBorder(e,t){return e("div",{class:"vxe-table-".concat(t,"ed-borders"),ref:"".concat(t,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(t,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(t,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(t,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(t,"Left")})])}function mergeMethod(e,t,l){for(var o=0;o<e.length;o++){var r=e[o],n=r.row,a=r.col,s=r.rowspan,i=r.colspan;if(-1<a&&-1<n&&s&&i){if(n===t&&a===l)return{rowspan:s,colspan:i};if(n<=t&&t<n+s&&a<=l&&l<a+i)return{rowspan:0,colspan:0}}}}function renderColumn(e,t,l,o,r,n,a,s,i,c,d,u,p,f,y,v,x){var g,m,b=l._e,h=l.$listeners,w=l.afterFullData,_=l.tableData,T=l.height,C=l.columnKey,$=l.overflowX,S=l.scrollXLoad,I=l.scrollYLoad,O=l.highlightCurrentRow,k=l.showOverflow,L=l.align,E=l.currentColumn,R=l.cellClassName,B=l.cellStyle,A=l.mergeList,P=l.spanMethod,q=l.radioOpts,D=l.checkboxOpts,M=l.expandOpts,N=l.treeOpts,U=l.tooltipOpts,F=l.mouseConfig,H=l.editConfig,j=l.editOpts,X=l.editRules,Y=l.validOpts,z=l.editStore,V=l.validStore,W=l.rowId,K=l.renderCellClass,G=p.cellRender,J=p.editRender,Q=p.align,Z=p.showOverflow,ee=p.className,te=p.treeNode,le=z.actived,oe=U.showAll||U.enabled,re=l.getColumnIndex(p),ne=l.getVTColumnIndex(p),ae=_tools.UtilTools.isEnableConf(J),se=a?p.fixed!==a:p.fixed&&$,ie=_ctor.default.isUndefined(Z)||_ctor.default.isNull(Z)?k:Z,ce="ellipsis"===ie,de="title"===ie,ue=!0===ie||"tooltip"===ie,pe=de||ue||ce,fe={},ye=Q||L,ve=V.row===i&&V.column===p,xe=X&&Y.showMessage&&("default"===Y.message?T||1<_.length:"inline"===Y.message),ge={"data-colid":p.id,rowId:i[W],colField:p.property||p.field},me=h["cell-mouseenter"],be=h["cell-mouseleave"],he=J&&H&&"dblclick"===j.trigger,we={$table:l,$seq:o,$$seq:x,seq:r,rowid:n,row:i,rowIndex:c,$rowIndex:d,_rowIndex:u,column:p,columnIndex:re,$columnIndex:f,_columnIndex:ne,fixed:a,type:cellType,isHidden:se,level:s,visibleData:w,data:_,items:v};if(!S&&!I||pe||(ce=pe=!0),(de||ue||oe||me)&&(fe.mouseenter=function(e){isOperateMouse(l)||(de?_tools.DomTools.updateCellTitle(e.currentTarget,p):(ue||oe)&&l.triggerBodyTooltipEvent(e,we),me&&l.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},we),e))}),(ue||oe||be)&&(fe.mouseleave=function(e){isOperateMouse(l)||((ue||oe)&&l.handleTargetLeaveEvent(e),be&&l.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},we),e))}),(D.range||F)&&(fe.mousedown=function(e){l.triggerCellMousedownEvent(e,we)}),(O||F||h["cell-click"]||J&&H||"row"===M.trigger||"cell"===M.trigger||"row"===q.trigger||"radio"===p.type&&"cell"===q.trigger||"row"===D.trigger||("checkbox"===p.type||"selection"===p.type)&&"cell"===D.trigger||"row"===N.trigger||p.treeNode&&"cell"===N.trigger)&&(fe.click=function(e){l.triggerCellClickEvent(e,we)}),(he||h["cell-dblclick"])&&(fe.dblclick=function(e){l.triggerCellDBLClickEvent(e,we)}),A.length){var _e=mergeMethod(A,u,ne);if(_e){var Te=_e.rowspan,Ce=_e.colspan;if(!Te||!Ce)return null;1<Te&&(ge.rowspan=Te),1<Ce&&(ge.colspan=Ce)}}else if(P){var $e=P(we)||{},Se=$e.rowspan,Ie=void 0===Se?1:Se,Oe=$e.colspan,ke=void 0===Oe?1:Oe;if(!Ie||!ke)return null;1<Ie&&(ge.rowspan=Ie),1<ke&&(ge.colspan=ke)}se&&A&&(1<ge.colspan||1<ge.rowspan)&&(se=!1),!se&&H&&(J||G)&&(j.showStatus||j.showUpdateStatus)&&(m=l.isUpdateByRow(i,p.property));var Le="seq"===p.type||"index"===p.type?"seq":p.type;return e("td",{class:["vxe-body--column",p.id,(g={},_defineProperty(g,"col--".concat(ye),ye),_defineProperty(g,"col--".concat(Le),Le),_defineProperty(g,"col--last",f===y.length-1),_defineProperty(g,"col--tree-node",te),_defineProperty(g,"col--edit",ae),_defineProperty(g,"col--ellipsis",pe),_defineProperty(g,"fixed--hidden",se),_defineProperty(g,"col--dirty",m),_defineProperty(g,"col--actived",H&&ae&&le.row===i&&(le.column===p||"row"===j.mode)),_defineProperty(g,"col--valid-error",ve),_defineProperty(g,"col--current",E===p),g),_tools.UtilTools.getClass(ee,we),_tools.UtilTools.getClass(R,we)].concat("function"==typeof K?K(we,t,l):K),key:C?p.id:f,attrs:ge,style:B?_ctor.default.isFunction(B)?B(we):B:null,on:fe},k&&se?[e("div",{class:["vxe-cell",{"c--title":de,"c--tooltip":ue,"c--ellipsis":ce}]})]:renderLine(e,t,l,s,v,we).concat([e("div",{class:["vxe-cell",{"c--title":de,"c--tooltip":ue,"c--ellipsis":ce}],attrs:{title:de?l.getCellLabel(i,p):null}},p.renderCell(e,we)),xe?ve?e("div",{class:"vxe-cell--valid",style:V.rule&&V.rule.maxWidth?{width:"".concat(V.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},V.content)]):b():null]))}function renderBodyTopRows(k,L,E,e,t,R,l,B){try{var o=E.bodyTopRowsConfig,r=E.bodyTopRowsData,A=void 0===r?[]:r,n=E.bodyTopData,a=void 0===n?[]:n,P=E.tooltipOpts,q=E.overflowX,D=E.currentColumn,M=E.columnKey,N=E.renderCellClass,s=o.enabled,i=o.rowStyle,c=o.rowClassName,U=o.spanMethod,F=o.cellStyle,H=o.bodyTopCellClassName;if(s){var j="topRow",X=A&&A.length?"dataObj":"data";return((A&&A.length?A:a)||[]).map(function(S,I){var O=I;return k("tr",{class:["vxe-top--row vxe-body--row vxe-body--top-row",c?_ctor.default.isFunction(c)?c({$table:E,_rowIndex:I,$rowIndex:O,fixed:R,type:j}):c:""],style:i?_ctor.default.isFunction(i)?i({$table:E,_rowIndex:I,$rowIndex:O,fixed:R,type:j}):i:null},B.map(function(t,e){var l,o=t.align,r=t.bodyTopClassName,n=t.showOverflow,a=P.showAll||P.enabled,s=t.children&&t.children.length,i=R?t.fixed!==R&&!s:t.fixed&&q,c=!(!_ctor.default.isUndefined(n)&&!_ctor.default.isNull(n))||n,d="ellipsis"===c,u="title"===c,p=!0===c||"tooltip"===c,f=o||"left",y=u||p||d,v={"data-colid":t.id},x={},g=E.getColumnIndex(t),m=E.getVTColumnIndex(t),b={$table:E,_rowIndex:I,$rowIndex:O,column:t,columnIndex:g,$columnIndex:e,_columnIndex:m,itemIndex:m,items:S,fixed:R,type:j,data:A,renderType:X};if((u||p||a)&&(x.mouseenter=function(e){u?_tools.DomTools.updateCellTitle(e.currentTarget,t):(p||a)&&E.triggerBodyTooltipEvent(e,b)}),(p||a)&&(x.mouseleave=function(e){(p||a)&&E.handleTargetLeaveEvent(e)}),x.click=function(e){E.emitEvent("top-cell-click",Object.assign({cell:e.currentTarget},b),e)},x.dblclick=function(e){E.emitEvent("top-cell-dblclick",Object.assign({cell:e.currentTarget},b),e)},U){var h=U(b)||{},w=h.rowspan,_=void 0===w?1:w,T=h.colspan,C=void 0===T?1:T;if(!_||!C)return null;1<_&&(v.rowspan=_),1<C&&(v.colspan=C)}var $="seq"===t.type||"index"===t.type?"seq":t.type;return k("td",{class:["vxe-top--column vxe-body--column vxe-body--top-td",t.id,(l={},_defineProperty(l,"col--".concat(f),f),_defineProperty(l,"col--".concat($),$),_defineProperty(l,"col--last",e===B.length-1),_defineProperty(l,"fixed--hidden",i),_defineProperty(l,"col--ellipsis",y),_defineProperty(l,"col--current",D===t),l),_tools.UtilTools.getClass(r,b),_tools.UtilTools.getClass(H,b)].concat("function"==typeof N?N(b,L,E):N),attrs:v,style:F?_ctor.default.isFunction(F)?F(b):F:null,on:x,key:M?t.id:e},[k("div",{class:["vxe-cell",{"c--title":u,"c--tooltip":p,"c--ellipsis":d}]},t.renderFooter(k,b))])}))})}return[]}catch(e){throw e}}function renderRows(y,v,x,g,m,b,h,w){var _=x.stripe,T=x.rowKey,C=x.highlightHoverRow,$=x.rowClassName,S=x.rowStyle,I=x.showOverflow,O=x.treeConfig,k=x.treeOpts,L=x.treeExpandeds,E=x.scrollYLoad,R=x.scrollYStore,B=x.editStore,A=x.rowExpandeds,P=x.radioOpts,q=x.checkboxOpts,D=x.expandColumn,M=[];return h.forEach(function(l,o){var e={},r=o,n=r+1;E&&(n+=R.startIndex);var a=x.getVTRowIndex(l);r=x.getRowIndex(l),C&&(e.mouseenter=function(e){isOperateMouse(x)||x.triggerHoverEvent(e,{row:l,rowIndex:r})},e.mouseleave=function(){isOperateMouse(x)||x.clearHoverRow()});var s=_tools.UtilTools.getRowid(x,l),t={$table:x,$seq:g,seq:n,rowid:s,fixed:b,type:cellType,level:m,row:l,rowIndex:r,$rowIndex:o};if(M.push(y("tr",{class:["vxe-body--row",{"row--stripe":_&&(x.getVTRowIndex(l)+1)%2==0,"is--new":-1<B.insertList.indexOf(l),"row--radio":P.highlight&&x.selectRow===l,"row--checked":q.highlight&&x.isCheckedByCheckboxRow(l)},$?_ctor.default.isFunction($)?$(t):$:""],attrs:{"data-rowid":s},style:S?_ctor.default.isFunction(S)?S(t):S:null,key:T||O?s:o,on:e},w.map(function(e,t){return renderColumn(y,v,x,g,n,s,b,m,l,r,o,a,e,t,w,h,O.scrollY&&E?l.$$seq:void 0)}))),D&&A.length&&-1<A.indexOf(l)){var i,c=x.getColumnIndex(D);O&&(i={paddingLeft:"".concat(m*k.indent+30,"px")});var d=D.showOverflow,u=_ctor.default.isUndefined(d)||_ctor.default.isNull(d)?I:d,p={$table:x,$seq:g,seq:n,column:D,columnIndex:c,fixed:b,type:cellType,level:m,row:l,rowIndex:r,$rowIndex:o};M.push(y("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:S?_ctor.default.isFunction(S)?S(p):S:null,on:e},[y("td",{class:["vxe-body--expanded-column",{"fixed--hidden":b,"col--ellipsis":u}],attrs:{colspan:w.length}},[y("div",{class:"vxe-body--expanded-cell",style:i},[D.renderData(y,p)])])]))}if((!O.scrollY||!E)&&O&&L.length){var f=l[k.children];f&&f.length&&-1<L.indexOf(l)&&M.push.apply(M,_toConsumableArray(renderRows(y,v,x,g?"".concat(g,".").concat(n):"".concat(n),m+1,b,f,w)))}}),M}function syncBodyScroll(e,t,l){(t||l)&&(t&&(t.onscroll=null,t.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){t&&(t.onscroll=t._onscroll),l&&(l.onscroll=l._onscroll)},300))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,t=this.$el,l=this.$refs,o=this.fixedType,r=e.elemStore,n="".concat(o||"main","-body-");r["".concat(n,"wrapper")]=t,r["".concat(n,"table")]=l.table,r["".concat(n,"colgroup")]=l.colgroup,r["".concat(n,"list")]=l.tbody,r["".concat(n,"xSpace")]=l.xSpace,r["".concat(n,"ySpace")]=l.ySpace,r["".concat(n,"emptyBlock")]=l.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e,t=this._e,o=this.$parent,r=this.fixedColumn,n=this.fixedType,a=o.$scopedSlots,s=o.tId,i=o.tableData,c=o.tableColumn,d=o.showOverflow,u=o.mergeList,p=o.spanMethod,f=o.scrollXLoad,y=o.mouseConfig,v=o.mouseOpts,x=o.emptyRender,g=o.emptyOpts,m=o.keyboardConfig,b=o.keyboardOpts,h=y&&v.checked;if(u.length||p||m&&b.isMerge||(n&&d?c=r:f&&n&&(c=r)),a.empty)e=a.empty.call(this,{$table:o},l);else{var w=x?_vXETable.default.renderer.get(g.name):null;e=w&&w.renderEmpty?w.renderEmpty.call(this,l,g,{$table:o},{$table:o}):o.emptyText||_conf.default.i18n("vxe.table.emptyText")}return l("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?t():l("div",{class:"vxe-body--x-space",ref:"xSpace"}),l("div",{class:"vxe-body--y-space",ref:"ySpace"}),l("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[l("colgroup",{ref:"colgroup"},c.map(function(e,t){return l("col",{attrs:{name:e.id},key:t})})),l("tbody",{ref:"tbody"},renderBodyTopRows(l,this,o,"",0,n,i,c).concat(renderRows(l,this,o,"",0,n,i,c)))]),n||!h&&!b.isCut?null:l("div",{class:"vxe-table--borders"},[h?renderBorder(l,"check"):null,b.isCut?renderBorder(l,"copy"):null]),l("div",{class:"vxe-table--checkbox-range"}),y&&v.area?l("div",{class:"vxe-table--cell-area"},[l("span",{class:"vxe-table--cell-main-area"},v.extension?[l("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){o.triggerCellExtendMousedownEvent(e,{$table:o,fixed:n,type:cellType})}}})]:null),l("span",{class:"vxe-table--cell-copy-area"}),l("span",{class:"vxe-table--cell-extend-area"}),l("span",{class:"vxe-table--cell-multi-area"}),l("span",{class:"vxe-table--cell-active-area"})]):null,n?null:l("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[l("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var t=this.$el,l=this.$parent,o=this.fixedType,r=l.$refs,n=l.highlightHoverRow,a=l.scrollXLoad,s=l.scrollYLoad,i=l.lastScrollTop,c=l.lastScrollLeft,d=r.tableHeader,u=r.tableBody,p=r.leftBody,f=r.rightBody,y=r.tableFooter,v=r.validTip,x=d?d.$el:null,g=y?y.$el:null,m=u.$el,b=p?p.$el:null,h=f?f.$el:null,w=t.scrollTop,_=m.scrollLeft,T=_!==c,C=w!==i;l.lastScrollTop=w,l.lastScrollLeft=_,l.lastScrollTime=Date.now(),n&&l.clearHoverRow(),b&&"left"===o?syncBodyScroll(w=b.scrollTop,m,h):h&&"right"===o?syncBodyScroll(w=h.scrollTop,m,b):(T&&(x&&(x.scrollLeft=m.scrollLeft),g&&(g.scrollLeft=m.scrollLeft)),(b||h)&&(l.checkScrolling(),C&&syncBodyScroll(w,b,h))),a&&T&&(l.triggerScrollXEvent(e),x&&_+m.clientWidth>=m.scrollWidth-80&&this.$nextTick(function(){m.scrollLeft!==x.scrollLeft&&(x.scrollLeft=m.scrollLeft)})),s&&C&&l.triggerScrollYEvent(e),v&&v.visible&&this.$parent.clearValidate(),l.emitEvent("scroll",{type:cellType,fixed:o,scrollTop:w,scrollLeft:_,isX:T,isY:C},e)}}};exports.default=_default;
# 大屏插件使用说明

## 设置博思 CNPM 私服

使用 yarn 设置私服

```cmd
yarn config set registry http://58.22.61.222:14873/
```

使用 npm 设置私服

```cmd
npm config set registry http://58.22.61.222:14873/
```

## 安装大屏插件

使用 YARN 安装

```cmd
yarn add @platform/charts-grid-layout

yarn add @platform/boss-interactive  //依赖包

yarn add @platform/boss-charts  //依赖包
```

使用 NPM 安装

```cmd
npm install @platform/charts-grid-layout --save

npm install @platform/boss-interactive  //依赖包

npm install @platform/boss-charts  //依赖包
```

## 引入大屏插件

```javascript
import ChartsGridLayout from '@platform/charts-grid-layout';
import BossInteractive from '@platform/boss-interactive';
import BossCharts from '@platform/boss-charts';

Vue.use(ChartsGridLayout);
Vue.use(BossInteractive);
Vue.use(BossCharts);
```

## 代理设置

```javascript
devServer:{
    hot: true,
    proxy: {
      '/datav': {
        target: 'http://192.168.10.156:8085/', //数据可视化服务地址
        changOrigin: true, //允许跨域
      }
    }
}

```

## 使用 code 获取大屏，向插件传递参数显示大屏

```javascript
<template>
  <charts-relative-layout :pageConfig="pageConfig" :charts="charts"></charts-relative-layout>
</template>

<script>
export default {
  data() {
    return {
      dataViewCode: 'ypfx_czsr', // 设计端对应的大屏code
      pageConfig: {},
      charts: []
    }
  },
  mounted() {
    this.init();
  },
  methods:{
    init() {
      // 根据应用系统各自的http请求方式调整写法
      this.$globalRequest(this.$apis.datav.getDatavLayout({ dataViewCode: this.dataViewCode })).then((res)=>{
        if (res.code === '200') {
          this.charts = res.data.chartInfos || [];
          this.pageConfig = JSON.parse(res.data.dataView.configurationString) || [];
        }
      })
    }
  }
}
</script>
```

```javascript
export function getDatavLayout(data) {
  return request({
    url: `/datav/v1/dashboard/deployed-dataView?dataViewCode=${data.dataViewCode}`,
    method: 'get'
  });
}
```

## 应用端替换图表数据获取的占位符

例如设计端图表数据获取设置了占位符 \${RQ} ，应用端需要等组件渲染完成后调用 setParams() 方法进行占位符内容替换，getParams()方法进行全局变量获取

```javascript
<template>
  <div>
    <el-button @click="getParams">测试</el-button>
    <charts-relative-layout ref="datav" :pageConfig="pageConfig" :charts="charts"></charts-relative-layout>
  </div>
</template>

<script>
export default {
  mounted() {
    this.setParams();
  },
  methods:{
    setParams() {
      let data = {
        RQ: 20210503
      }
      let obj = {nofresh:['qh','code']}//nofresh，由于组件之间的联动，组件A\B\C,组件A于B联动，B于C联动，当A组件参数更新时，B组件默认值将被重置。由于地图组件自身联动，既是组件A,也是组件B，参数值会被重置，在 nofresh中添加地图组件参数名，则可以排除重置。
      //当地图组件参数需要设置值时，将地图组件参数名写于此，避免参数被重置为默认值
      this.$refs.datav.setParams(data,obj);
    },
    getParams() {
      let params = this.$refs.datav.getParams();
      console.log(params);
    }
  }
}
</script>
```

## 事件

例如设计端组件的交互配置设置了点击事件名为'clickMap' ，则点击该组件时返回的 eventName 值就为'clickMap'，以此来区分不同的点击事件

```vue
<template>
  <div>
    <el-button type="primary" @click="changeMap('35')">福建</el-button>
    <charts-grid-layout @clickChart="clickChart" @loadedChart="loadedChart"></charts-grid-layout>
  </div>
</template>
<script>
export default {
  data() {
    return {};
  },
  methods: {
    /**
     * 点击事件
     *
     * @private
     * @param {string} eventName 事件名称
     * @param {Object} event 事件对象
     * @param {Object} chartInstance 当前vue组件实例
     */
    clickChart(eventName, event, chartInstance) {
      console.log(eventName, event, chartInstance);
      alert('clickChart');
    }
     /**
     * 加载完成
     *
     * @private
     * @param {string} eventName 事件名称
     * @param {Object} chartInstance 当前vue组件实例
     */
    loadedChart(eventName, chartInstance) {
      this.o[eventName] = chartInstance;
      console.log(this.o);
    },
    //通过修改当前地图区域
    changeMap(){
      this.o['map'].setMapCode('00');//修改当前地图区域
    }
  }
};
</script>
```

### 事件

| 方法名     | 说明     | 参数 |
| ---------- | -------- | ---- |
| clickChart | 点击事件 | —    |

| 参数          | 说明                                                                                                                                         | 类型   | 重要可选值                                                                    |
| ------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ------ | ----------------------------------------------------------------------------- |
| eventName     | 事件名称                                                                                                                                     | string | -                                                                             |
| event         | echart [原生事件对象](https://echarts.apache.org/zh/tutorial.html#ECharts%20%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%92%8C%E8%A1%8C%E4%B8%BA) | Object | name: 数据名/类目名,data: // 传入的原始数据项                                 |
| chartInstance | 当前 vue 组件实例                                                                                                                            | Object | option //echartoption , componentData //当前数组数据, chart//当前 echart 实例 |

## iframe 方式嵌入大屏时应用端替换图表数据获取的占位符

例如设计端图表数据获取设置了占位符 \${RQ} ，应用端需要等组件渲染完成后调用 setParams() 方法进行占位符内容替换

```javascript
<template>
  <div>
    <el-button @click="setParams">测试</el-button>
    <iframe ref="iframe" class="iframe" src="http://localhost:8080/#/publishView/dashboard?dataViewCode=33444" frameborder="0"></iframe>
  </div>
</template>

<script>
export default {
  methods: {
    setParams() {
      let message = {
        source: 'datavUser',  // 请求源约定设置，用于接收端判断请求是否可信赖
        methods: 'setParams', // 需要调用组件方法的方法名
        data: {               // 调用方法传递的参数
          RQ: 20210503
        }
      }
      this.$refs.iframe.contentWindow.postMessage(message, "http://localhost:8080"); // 第二个参数需要设置postMessage的目标窗口，防止信息泄露
    }
  }
}
</script>
```

## 打印模板插件对接

```javascript
<template>
  <ChartsEditPrintLayout :printTemplateCode="printTemplateCode" :config="config" :userCode="userCode" :printTemplateParams="printTemplateParams" @loaded="loaded"     @printEnded="printEnded"></ChartsEditPrintLayout>
</template>

<script>
export default {
  data() {
    return {
      config: {
        isHidden: true//控制组件显示隐藏,true 为隐藏，false为显示
      },
      printTemplateCode: 'tet',// 对应的大屏code
      userCode: 'admin',//对应的用户编码
      printTemplateParams:[{cc:'hh'},{cc:'hh1'}]//批量打印参数列表，打印多页传对应数量参数对象
    };
  },
  methods:{
    printEnded() {
      console.log('printEnded');
    },
    loaded() {
      console.log('loaded');
    }
  }
};
</script>

```

```

```
